version: '3.8'

services:
  # Windows FORScan service
  forscan:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: forscan-portable
    # Use Windows containers
    platform: windows/amd64
    
    # Mount volumes using Windows path syntax
    volumes:
      - type: bind
        source: ./data
        target: C:/app/forscan/data
      - type: bind
        source: ./config
        target: C:/app/forscan/config
    
    # Environment variables for Windows
    environment:
      FORSCAN_PORTABLE: "true"
      FORSCAN_DATA_DIR: "C:/app/forscan/data"
      FORSCAN_CONFIG_DIR: "C:/app/forscan/config"
    
    # Network configuration (if needed for adapter communication)
    # ports:
    #   - "8080:8080"
    
    # Resource limits for Windows containers
    deploy:
      resources:
        limits:
          memory: 2G
          cpus: '2.0'
        reservations:
          memory: 512M
          cpus: '0.5'
    
    # Restart policy
    restart: unless-stopped
    
    # Health check
    healthcheck:
      test: ["CMD", "powershell", "-Command", "if (Test-Path 'C:\\app\\forscan') { exit 0 } else { exit 1 }"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # Python automation service
  forscan-python:
    build:
      context: .
      dockerfile: Dockerfile.python
      target: python-env
    container_name: forscan-python
    platform: linux/amd64
    
    volumes:
      - type: bind
        source: ./data
        target: /app/data
      - type: bind
        source: ./config
        target: /app/config
      - type: bind
        source: ./logs
        target: /app/logs
      - type: bind
        source: ./python
        target: /app/python
    
    environment:
      PYTHONPATH: "/app"
      FORSCAN_PYTHON_ENV: "true"
      FORSCAN_DATA_DIR: "/app/data"
      FORSCAN_CONFIG_DIR: "/app/config"
      FORSCAN_LOG_DIR: "/app/logs"
    
    ports:
      - "8000:8000"  # API server
      - "5000:5000"  # Development server
    
    depends_on:
      - forscan
    
    restart: unless-stopped
    
    healthcheck:
      test: ["CMD", "python", "-c", "import sys; sys.exit(0)"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 20s

# Optional: Service for development/testing
  forscan-dev:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: forscan-dev
    platform: windows/amd64
    
    volumes:
      - type: bind
        source: .
        target: C:/app
      - type: bind
        source: ./data
        target: C:/app/forscan/data
      - type: bind
        source: ./config
        target: C:/app/forscan/config
    
    environment:
      FORSCAN_PORTABLE: "true"
      FORSCAN_DEBUG: "true"
      FORSCAN_DATA_DIR: "C:/app/forscan/data"
      FORSCAN_CONFIG_DIR: "C:/app/forscan/config"
    
    # Override default command for development
    command: powershell -Command "Write-Host 'FORScan development container ready'; Start-Sleep -Seconds 3600"
    
    profiles:
      - development

  # Python development environment
  python-dev:
    build:
      context: .
      dockerfile: Dockerfile.python
      target: development
    container_name: forscan-python-dev
    platform: linux/amd64
    
    volumes:
      - type: bind
        source: .
        target: /app
      - type: bind
        source: ./data
        target: /app/data
      - type: bind
        source: ./config
        target: /app/config
      - type: bind
        source: ./logs
        target: /app/logs
    
    environment:
      PYTHONPATH: "/app"
      FORSCAN_DEBUG: "true"
      FORSCAN_PYTHON_ENV: "true"
      FORSCAN_DATA_DIR: "/app/data"
      FORSCAN_CONFIG_DIR: "/app/config"
      FORSCAN_LOG_DIR: "/app/logs"
    
    ports:
      - "8001:8000"  # Development API server
      - "5001:5000"  # Development server
    
    command: python -c "print('Python development environment ready'); import time; time.sleep(3600)"
    
    profiles:
      - development